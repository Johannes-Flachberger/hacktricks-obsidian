name: Transform contents and update main branch

on:
  workflow_dispatch: # manual trigger
  workflow_run:
    workflows: [ 'Fetch contents from Hacktricks repos' ]
    types: [ completed ]

jobs:
  transform-and-update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 # needed to push changes later

    - name: Install Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r scripts/requirements.txt

    - name: Transform hacktricks content
      run: |
        git fetch origin hacktricks-master
        git checkout origin/hacktricks-master -- src/
        git reset HEAD src/
        python scripts/transform.py
        rsync -a --delete --exclude='.obsidian/' ./src/ ./hacktricks-all/hacktricks/
        rm -rf ./src/

    - name: Transform hacktricks-cloud content
      run: |
        git fetch origin hacktricks-cloud-master
        git checkout origin/hacktricks-cloud-master -- src/
        git reset HEAD src/
        python scripts/transform.py
        rsync -a --delete --exclude='.obsidian/' ./src/ ./hacktricks-all/hacktricks-cloud/
        rm -rf ./src/

    - name: Commit and push to main
      run: |
        # Configure git
        git config user.name "github-actions"
        git config user.email "actions@github.com"

        # Commit and push only if there are changes
        git add ./hacktricks/
        git diff --cached --quiet || git commit -m "Updated contents from hacktricks-wiki repos"
        git push origin main
